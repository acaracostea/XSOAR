category: Utilities
commonfields:
  id: XSOAR Engineer Training
  version: -1
configuration:
- display: Events to fetch
  name: events_type
  options:
  - All
  - Blocked URLs
  - Allowed URLs
  required: false
  type: 15
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: "20"
  display: Number of events per fetch
  name: number_to_fetch
  required: false
  type: 0
- defaultvalue: "5"
  display: Incidents Fetch Interval
  name: incidentFetchInterval
  required: false
  type: 19
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.8.0
    itemVersion: 1.0.0
    packID: XSOAR_Engineer_Training
    packName: XSOAR Engineer Training
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: "This integration provides sample data to fetch events into XSOAR, and
  commands to build playbooks around.\n\nUse for training purposes only. "
detaileddescription: |-
  ### Community Contributed Integration
   #### Integration Author: beauchompers
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***
  Did you know that 68% of all statistics are made up? But only 13% of people know that?

  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/xsoar-engineer-training)
display: XSOAR Engineer Training (Community Contribution)
image: data:image/png;base64,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
name: XSOAR Engineer Training
script:
  commands:
  - arguments: []
    description: Fetches events for all clicks and messages relating to known threats
      within the specified time period. Details as per clicks/blocked.
    name: xsoar-engineer-get-events
  - arguments:
    - description: The Distinguished Name of the user in which to return information.
      name: dn
    - description: Queries users by the samAccountName attribute.
      name: username
    - default: true
      description: Queries by the user's email address.
      name: email
    description: Retrieves detailed information about a user account. The user can
      be specified by username, email address, or as an Active Directory Distinguished
      Name (DN).
    name: ad-get-user
    outputs:
    - contextPath: ActiveDirectory.Users.dn
      description: The distinguished name of the user.
    - contextPath: ActiveDirectory.Users.displayName
      description: The display name of the user.
    - contextPath: ActiveDirectory.Users.name
      description: The common name of the user.
    - contextPath: ActiveDirectory.Users.sAMAccountName
      description: The sAMAccountName of the user.
    - contextPath: ActiveDirectory.Users.userAccountControl
      description: The account control flag of the user.
    - contextPath: ActiveDirectory.Users.mail
      description: The email address of the user.
    - contextPath: ActiveDirectory.Users.manager
      description: The manager of the user.
    - contextPath: ActiveDirectory.Users.memberOf
      description: Groups for which the user is a member.
    - contextPath: Account.DisplayName
      description: The display name of the user.
    - contextPath: Account.Groups
      description: Groups for which the user is a member.
    - contextPath: Account.Manager
      description: The manager of the user.
    - contextPath: Account.ID
      description: The distinguished name of the user.
    - contextPath: Account.Username
      description: The samAccountName of the user.
    - contextPath: Account.Email
      description: The email address of the user.
  - arguments:
    - description: The username (samAccountName) of the user to modify.
      name: username
      required: true
    description: Expires the password of an Active Directory user.
    name: ad-expire-password
  - arguments:
    - description: The username of the account to disable (sAMAccountName).
      name: username
      required: true
    - description: The password to set for the user.
      name: password
      required: true
    description: Sets a new password for an Active Directory user.
    name: ad-set-new-password
  - arguments:
    - description: The query to execute against the SIEM.
      name: query
      required: true
    - auto: PREDEFINED
      description: Type of result to return for this siem integration.
      name: result_type
      predefined:
      - email
      - hosts
    description: Searches the simulated SIEM for events.
    name: siem-search
    outputs:
    - contextPath: SIEM.Result
      description: The results of the SIEM search. The results are a JSON array, in
        which each item is a SIEM event.
  - arguments:
    - description: Who to send the fake email to.
      name: to
      required: true
    description: Send an email (doesn't actually send an email)
    name: send-mail
  dockerimage: demisto/python3:3.10.10.48392
  isfetch: true
  runonce: false
  script: |
    register_module_line('XSOAR Engineer Training', 'start', __line__())


    from datetime import datetime, timedelta
    from random import randrange, choice, randint
    from copy import deepcopy
    import json


    ''' SAMPLE EVENTS '''

    SAMPLE_EVENT = {
        "type": "url allowed",
        "eventID": "007",
        "urlCategory": "MALWARE",
        "sourceIP": "10.8.8.8",
                    "occurred": "2023-01-01T00:00:01.000Z",
                    "sourceUser": "james.bond@xsoar.local",
                    "url": "https://notthedomainyouarelookingfor.com/login.zip",
                    "userAgent": "Mozilla/5.0(WindowsNT6.1;WOW64;rv:27.0)Gecko/20100101Firefox/27.0"
    }

    ALL_EVENTS = "All"
    BLOCKED_URLS = "Blocked URLs"
    ALLOWED_URLS = "Allowed URLs"

    TYPES = ["url allowed", "url blocked"]
    USERS = ["james.bond@xsoar.local", "eve.moneypenny@xsoar.local", "m@xsoar.local", "q@xsoar.local"]
    ALLOWED_CATEGORIES = ["PHISH", "MALWARE", "SPAM"]
    BLOCKED_CATEGORIES = ["PHISH", "MALWARE", "SPAM"]

    SOURCEIPS = ["10.8.8.8", "10.8.8.9", "10.8.8.10", "10.8.8.10", "10.8.8.10", "10.8.8.10", "10.8.8.10",
                 "10.8.8.10", "88.8.8.8", "88.8.8.9", "88.8.8.10", "88.8.8.11", "88.8.8.12", "88.8.8.13"]
    DEFAULT_LIMIT = 20
    DATE_FORMAT = "%Y-%m-%dT%H:%M:%SZ"

    ''' ACTIVE DIRECTORY QUERY V2 INTEGRATION '''

    # Lab version of AD. Simulate the ad-get-user, ad-expire-password, and ad-set-new-password responses.
    # Fun fact about data.  68% of all data is made up, but only 8% of people know that.

    USERS = [
        {
            "email": "james.bond@xsoar.local",
            "displayname": "James Bond",
            "samaccountname": "XSOAR007",
            "dn": "CN=James Bond,CN=Users,DC=xsoar,DC=local",
            "group": "CN=Agents,CN=Users,DC=xsoar,DC=local",
            "manager": "CN=M,CN=Users,DC=xsoar,DC=local"
        },
        {
            "email": "eve.moneypenny@xsoar.local",
            "displayname": "Eve Moneypenny",
            "samaccountname": "XSOAR002",
            "dn": "CN=Eve Moneypenny,CN=Users,DC=xsoar,DC=local",
            "group": "CN=Administration,CN=Users,DC=xsoar,DC=local",
            "manager": "CN=M,CN=Users,DC=xsoar,DC=local"
        },
        {
            "email": "m@xsoar.local",
            "displayname": "M",
            "samaccountname": "XSOAR001",
            "dn": "CN=M,CN=Users,DC=xsoar,DC=local",
            "group": "CN=Managers,CN=Users,DC=xsoar,DC=local",
            "manager": "CN=James Bond,CN=Users,DC=xsoar,DC=local"
        },
        {
            "email": "q@xsoar.local",
            "displayname": "Q",
            "samaccountname": "XSOAR003",
            "dn": "CN=Q,CN=Users,DC=xsoar,DC=local",
            "group": "CN=Gadgets,CN=Users,DC=xsoar,DC=local",
            "manager": "CN=James Bond,CN=Users,DC=xsoar,DC=local"
        }
    ]


    """ Helper functions """


    def get_now():
        """
        A wrapper function of datetime.now
        helps handle tests

        Returns:
            datetime: time right now
        """
        return datetime.now()


    def mock_data(total):
        """
        Changes mocks the data to randomize the alerts a bit. Pass in the total number of events to create for some fun.
        """
        now = get_now()
        data = []
        count = 0

        users = [x['email'] for x in USERS]
        while count < total:
            item = deepcopy(SAMPLE_EVENT)
            item['occurred'] = (now - timedelta(minutes=randrange(6, 60))).strftime('%Y-%m-%dT%H:%M:%SZ')
            item['eventID'] = randrange(100, 10000)
            item['type'] = choice(TYPES)
            if item['type'] == 'url blocked':
                item['urlCategory'] = choice(BLOCKED_CATEGORIES)
            else:
                item['urlCategory'] = choice(ALLOWED_CATEGORIES)
            item['sourceUser'] = choice(users)
            item['sourceIP'] = choice(SOURCEIPS)

            if item["urlCategory"] == "MALWARE":
                item["url"] = f"https://notthedomainyouarelookingfor{randrange(1,88)}.com/download.zip"
            if item["urlCategory"] == "PHISH":
                item["url"] = f"https://notthedomainyouarelookingfor{randrange(1,88)}.com/login.php"
            if item["urlCategory"] == "SPAM":
                item["url"] = f"https://nplusone{randrange(1,10)}.ca/getnewbike"

            data.append(item)
            count += 1
        return data


    def lookup_ad_user(lookup, attribute):
        """
        Returns the user details from the USERS global var
        """
        found_user = False
        for u in USERS:
            if u[attribute] == lookup:
                found_user = True
                return u
                break

        if not found_user:
            return []


    def create_ad_user_output(user):
        """
        returns the user object for using the USER_TEMPLATE
        """
        user_template = {
            "attributes": {
                "displayName": [
                    f"{user['displayname']}"
                ],
                "mail": [
                    f"{user['email']}"
                ],
                "manager": [
                    f"{user['manager']}"
                ],
                "memberOf": [
                    f"{user['group']}"
                ],
                "name": [
                    f"{user['displayname']}"
                ],
                "sAMAccountName": [
                    f"{user['samaccountname']}"
                ],
                "userAccountControl": [
                    512
                ],
                "dn": f"{user['dn']}"
            },
            "account": {
                "DisplayName": [
                    f"{user['displayname']}"
                ],
                "Email": [
                    f"{user['email']}"
                ],
                "Manager": [
                    f"{user['manager']}"
                ],
                "Groups": [
                    f"{user['group']}"
                ],
                "Type": "AD",
                "Username": [
                    f"{user['samaccountname']}"
                ],
                "ID": f"{user['dn']}"
            }
        }

        return user_template


    """ Command functions """


    def get_events_command(args):
        """
        returns the events, in this case the mock data
        """
        event_type_filter = args.get("eventTypes")
        total = randrange(10, 20)
        events = mock_data(total)
        readable = tableToMarkdown("Training Events", events)
        results = CommandResults(readable_output=readable, ignore_auto_extract=True)
        return results


    def simple_response_command(command):
        """
        returns a text response for the Active Directory and send mail Commands
        """
        command_map = {
            'ad-expire-password': 'Expired password successfully',
            'ad-set-new-password': 'User password successfully set',
            'send-mail': 'notification sent'
        }
        return CommandResults(readable_output=command_map[command], ignore_auto_extract=True)


    def ad_get_user_command(args):
        """
        Returns the user details from our simulated AD if the user is found
        """

        # error handing for Ori
        if not args.get('username') and not args.get('email') and not args.get('dn'):
            return_error("Need either a username, email, or dn")

        # lookup the user
        if args.get('email'):
            username = args.get('email')
            user = lookup_ad_user(username, 'email')
        if args.get('username'):
            username = args.get('username')
            user = lookup_ad_user(username, 'samaccountname')
        if args.get('dn'):
            username = args.get('dn')
            user = lookup_ad_user(username, 'dn')

        # create the user response
        if user:
            user_output = create_ad_user_output(user)

            # return results like AD query would.
            demisto_entry = {
                'ContentsFormat': formats['json'],
                'Type': entryTypes['note'],
                'Contents': user_output,
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown("Active Directory - Get Users", user_output.get('attributes')),
                'EntryContext': {
                    'ActiveDirectory.Users(obj.dn == val.dn)': user_output.get('attributes'),
                    'Account(obj.ID == val.ID)': user_output.get('account')
                }
            }

            return demisto_entry
        else:
            return "No user found"


    def siem_search_command(args):
        query = args.get('query')
        result_type = args.get('result_type')
        number = randint(1, 10)

        # return results for demo of siem search in example playbook.
        if result_type == "email" or query.startswith("email"):
            result = [
                {
                    "Username": "XSOAR007",
                    "Email": "james.bond@xsoar.local"
                },
                {
                    "Username": "XSOAR001",
                    "Email": "m@xsoar.local"
                }
            ]
        # return some data if the number is right. Demonstrate Built-in looping in a sub-playbook.
        elif number >= 7 or result_type == "hosts" or query.startswith("username"):
            result = [
                {
                    "Host": "crossiscoming01",
                    "Online": "Yes"
                },
                {
                    "Host": "crossiscoming02",
                    "Online": "No"
                }
            ]
        # return some data if the number is right. Demonstrate Built-in looping in a sub-playbook.
        elif query.startswith("ip"):
            result = [
                {
                    "Host": "crossiscoming01",
                    "Online": "Yes"
                }
            ]
        else:
            result = []

        results = CommandResults(
            readable_output=tableToMarkdown(f"SIEM Search results for query: {query}", result),
            outputs_prefix="SIEM.Result",
            outputs=result)

        return results


    def fetch_incidents(limit=DEFAULT_LIMIT):
        """
        fetch!
        """
        incidents = []

        # get last run, can be used to store the last fetch time.
        last_run_object = demisto.getLastRun()
        if 'time' in last_run_object.keys():
            last_run = last_run_object.get('time')
            demisto.info(f"XET - We have a last run object, previous last_run: {last_run}")
        else:
            last_run = get_now().strftime('%Y-%m-%dT%H:%M:%SZ')

        count = randrange(10, limit)
        events = mock_data(count)

        for event in events:
            if event.get("type") == "url allowed":
                event_type = "URL Allowed"
            else:
                event_type = "URL Blocked"
            event_user = event.get("sourceUser", "")
            incident = {
                "name": f"Alert - {event_type}- {event_user}",
                "rawJSON": json.dumps(event),
                "occurred": event["occurred"]
            }
            incidents.append(incident)

        # set last run
        next_run = {"time": get_now().strftime('%Y-%m-%dT%H:%M:%SZ')}
        demisto.setLastRun(next_run)
        demisto.info(f"XET - Setting LastRun: {next_run}")

        # return our list of Incidents
        return incidents[:limit]


    ''' COMMANDS MANAGER / SWITCH PANEL '''


    def main():
        """
        main function to run things
        """
        params = demisto.params()
        fetch_limit = 20

        command = demisto.command()
        LOG(f'Command being called is {command}')

        try:
            commands = {
                'xsoar-engineer-get-events': get_events_command,
                'ad-expire-password': simple_response_command,
                'send-mail': simple_response_command
            }
            if command == 'test-module':
                demisto.results('ok')
            elif demisto.command() == 'fetch-incidents':
                demisto.incidents(fetch_incidents(limit=fetch_limit))
            elif demisto.command() == 'xsoar-engineer-get-events':
                return_results(get_events_command(demisto.args()))
            elif demisto.command() == 'ad-get-user':
                demisto.results(ad_get_user_command(demisto.args()))
            elif demisto.command() == 'siem-search':
                return_results(siem_search_command(demisto.args()))
            elif command in commands:
                return_results(commands[command](command))

        except Exception as e:
            return_error(str(e))


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()

    register_module_line('XSOAR Engineer Training', 'end', __line__())
  subtype: python3
  type: python
system: true
